name: Publish Internal

on:
  repository_dispatch:
    types: [publish-internal]

jobs:

  publish:
    runs-on:
      - self-hosted
      - linux
      - aws

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.client_payload.ref }}

      - run: echo ::set-output name=commitsha::$(git rev-parse --short HEAD)

      - name: Cache Gradle packages
        uses: actions/cache@v1
        with:
          path: /root/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: ${{ runner.os }}-gradle

      - name: Publish
        id: publish
        uses: ./.github/actions/publish-action
        env:
          BUILD_FLAVOR: Internal
          PLAY_TRACK: internal
          GOOGLE_SERVICES: ${{ secrets.GoogleServices }}
          PLAY_SERVICES: ${{ secrets.PlayServices }}
          SIGNING_KEY_STORE: ${{ secrets.signingKeyStore }}
          SIGNING_KEY_ALIAS: ${{ secrets.signingKeyStoreAlias }}
          SIGNING_KEY_STORE_PASSWORD: ${{ secrets.signingKeyStorePassword }}
          SIGNING_KEY_PASSWORD: ${{ secrets.signingKeyPassword }}
          SONAR_HEADER_VALUE: ${{ secrets.TestSonarHeaderValue }}
          SONAR_ANALYTICS_KEY: ${{ secrets.TestSonarAnalyticsKey }}
          SONAR_BASE_URL: https://test.route.cp.data.england.nhs.uk
          COMMIT_SHA: ${{ github.event.client_payload.ref }}

      - name: Upload APK
        uses: actions/upload-artifact@v2
        with:
          name: app-internal-${{ steps.publish.outputs.buildVersion }}.apk
          path: app/build/outputs/apk/internal/app-internal.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v2
        with:
          name: app-internal-${{ steps.publish.outputs.buildVersion }}.aab
          path: app/build/outputs/bundle/internal/app-internal.aab

      - name: Notify Slack
        uses: rtCamp/action-slack-notify@v2.0.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SonarAndroidWebHook }}
          SLACK_COLOR: '#138275'
          SLACK_USERNAME: CI
          SLACK_TITLE: New Internal Release ${{ steps.publish.outputs.buildVersion }}
          SLACK_MESSAGE: APK and AAB are uploaded as job artefacts
